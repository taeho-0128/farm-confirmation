<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>농산물 판매 확인서</title>

<!-- 사진 저장용 html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background:#f5f5f5;
        padding:12px;
        margin:0;
    }
    .container {
        max-width:1200px;
        margin:0 auto;
        display:flex;
        gap:16px;
    }
    .box {
        background:white;
        border-radius:10px;
        padding:18px;
        flex:1;
        box-sizing:border-box;
    }
    .input-box h2 {
        margin:0 0 16px 0;
        font-size:18px;
    }
    .input-box label {
        display:block;
        margin-top:8px;
        margin-bottom:3px;
        font-size:13px;
        font-weight:bold;
    }
    .input-box input {
        width:100%;
        padding:7px 9px;
        border-radius:6px;
        border:1px solid #ccc;
        font-size:13px;
        box-sizing:border-box;
    }

    #pcSignCanvas {
        width:100%;
        height:140px;
        border:1px solid #aaa;
        background:#fff;
        margin-top:6px;
        touch-action:none;
    }

    .title {
        text-align:center;
        font-size:20px;
        font-weight:bold;
        margin:0 0 18px 0;
    }
    .preview p {
        font-size:14px;
        margin:4px 0;
    }

    #signPreview {
        width:240px;
        height:110px;
        border:1px solid #ccc;
        background:#fff;
        margin-top:4px;
        margin-bottom:3px;
    }

    .footer-line {
        margin-top:8px;
        margin-bottom:0;
        font-weight:bold;
        font-size:15px;
        text-align:center;
    }

    #buttons {
        text-align:center;
        margin-top:16px;
    }
    button {
        padding:9px 14px;
        margin:0 5px;
        border-radius:6px;
        border:1px solid #ccc;
        background:white;
        cursor:pointer;
        font-size:14px;
    }
    .blue-btn {
        background:#3b82f6;
        border:none;
        color:white;
    }

    @media (max-width:900px) {
        .container {
            flex-direction:column;
        }
    }

    /* 인쇄 시 여백 최소화 */
    @media print {
        body, .container {
            margin:0 !important;
            padding:0 !important;
            background:white !important;
        }
        .input-box,
        #buttons {
            display:none !important;
        }
        .preview {
            padding:12px 18px 4px 18px !important;
        }
    }
</style>
</head>

<body>

<div class="container">
    <!-- LEFT : 입력 폼 -->
    <div class="box input-box">
        <h2>입력 폼</h2>

        <label>품목</label><input id="item">
        <label>원산지</label><input id="origin">
        <label>생산년도</label><input id="year">
        <label>판매량</label><input id="qty">
        <label>판매단가</label><input id="unitPrice">
        <label>금액</label><input id="amount">
        <label>입금계좌번호</label><input id="bank">
        <label>연락처</label><input id="phone">
        <label>성명</label><input id="name">
        <label>주민등록번호</label><input id="rrn">
        <label>농업경영체등록번호</label><input id="farmId">
        <label>날짜</label><input id="date">

        <h3 style="margin-top:18px; font-size:15px;">PC 서명</h3>
        <canvas id="pcSignCanvas"></canvas>
        <button style="margin-top:6px;" onclick="clearPcSign()">서명 지우기</button>
    </div>

    <!-- RIGHT : 미리보기 / 실제 출력 영역 -->
    <div class="box preview" id="printArea">
        <div class="title">농산물 판매 확인서</div>

        <p>* 품목 : <span id="pv_item"></span></p>
        <p>* 원산지 : <span id="pv_origin"></span></p>
        <p>* 생산년도 : <span id="pv_year"></span></p>
        <p>* 판매량 : <span id="pv_qty"></span></p>
        <p>* 판매단가 : <span id="pv_unitPrice"></span></p>
        <p>* 금액 : <span id="pv_amount"></span></p>
        <p>* 입금계좌번호 : <span id="pv_bank"></span></p>
        <p>* 연락처 : <span id="pv_phone"></span></p>
        <p>* 성명 : <span id="pv_name"></span></p>
        <p>* 주민등록번호 : <span id="pv_rrn"></span></p>
        <p>* 농업경영체등록번호 : <span id="pv_farmId"></span></p>

        <p style="margin:22px 0 18px; text-align:center;">
            위와 같이 판매하였음을 확인합니다.
        </p>

        <p style="margin-bottom:4px;"><b>서명</b></p>
        <img id="signPreview" alt="서명 이미지">

        <p class="footer-line">농업회사법인(주)원당에프앤디 귀중</p>
    </div>
</div>

<div id="buttons">
    <button onclick="saveImage()">사진 저장</button>
    <button onclick="window.print()">인쇄하기</button>
    <button class="blue-btn" onclick="createSignURL()">서명 받기 URL 복사</button>
</div>

<script>
/* --- Base64 helper --- */
function encodeBase64(str){
    return btoa(unescape(encodeURIComponent(str)));
}
function decodeBase64(str){
    return decodeURIComponent(escape(atob(str)));
}

/* --- 입력 → 미리보기 --- */
const fields = [
  "item","origin","year","qty",
  "unitPrice","amount","bank","phone",
  "name","rrn","farmId","date"
];

fields.forEach(id => {
    const input = document.getElementById(id);
    input.addEventListener("input", () => {
        const span = document.getElementById("pv_" + id);
        if (span) span.innerText = input.value;
    });
});

/* 현재 입력값 모으기 */
function collectData(){
    const data = {};
    fields.forEach(id => {
        data[id] = document.getElementById(id).value || "";
    });
    return data;
}

/* --- PC 서명 --- */
const pcCanvas = document.getElementById("pcSignCanvas");
const pcCtx = pcCanvas.getContext("2d");
let drawing = false;

function resizePcCanvas(){
    const rect = pcCanvas.getBoundingClientRect();
    pcCanvas.width = rect.width;
    pcCanvas.height = rect.height;
}
resizePcCanvas();
window.addEventListener("resize", resizePcCanvas);

function getPcPos(e){
    const rect = pcCanvas.getBoundingClientRect();
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

pcCanvas.addEventListener("pointerdown", e => {
    drawing = true;
    const p = getPcPos(e);
    pcCtx.beginPath();
    pcCtx.moveTo(p.x, p.y);
});

pcCanvas.addEventListener("pointermove", e => {
    if (!drawing) return;
    const p = getPcPos(e);
    pcCtx.lineWidth = 2;
    pcCtx.lineCap = "round";
    pcCtx.strokeStyle = "black";
    pcCtx.lineTo(p.x, p.y);
    pcCtx.stroke();
    pcCtx.beginPath();
    pcCtx.moveTo(p.x, p.y);

    // PC 서명도 미리보기 이미지에 반영
    document.getElementById("signPreview").src =
        pcCanvas.toDataURL("image/png");
});

pcCanvas.addEventListener("pointerup", () => drawing = false);
pcCanvas.addEventListener("pointerleave", () => drawing = false);

function clearPcSign(){
    pcCtx.clearRect(0, 0, pcCanvas.width, pcCanvas.height);
    document.getElementById("signPreview").src = "";
}

/* --- 서명 받기 URL 생성 (PC → 모바일) --- */
function createSignURL(){
    const payload = { data: collectData() };  // 입력값만 보냄
    const encoded = encodeBase64(JSON.stringify(payload));
    const url = window.location.origin + "/sign.html?pack=" +
                encodeURIComponent(encoded);

    navigator.clipboard.writeText(url)
        .then(() => alert("서명용 URL이 복사되었습니다!"))
        .catch(() => alert("복사에 실패했습니다. 아래 주소를 직접 복사해 주세요.\n" + url));
}

/* --- 사진 저장 (미리보기 영역을 PNG로) --- */
async function saveImage(){
    const area = document.getElementById("printArea");
    const canvas = await html2canvas(area, {
        scale: 2,
        useCORS: true,
        scrollX: 0,
        scrollY: -window.scrollY,
        windowWidth: area.scrollWidth,
        windowHeight: area.scrollHeight
    });

    const dataURL = canvas.toDataURL("image/png");

    const link = document.createElement("a");
    link.href = dataURL;
    link.download = "농산물_판매_확인서.png";

    if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
        window.open(dataURL);
    } else {
        link.click();
    }
}


/* --- 모바일에서 돌아온 URL(pack) 복원 --- */
(function restoreFromPack(){
    const params = new URLSearchParams(window.location.search);
    const packRaw = params.get("pack");
    if (!packRaw) return;

    try {
        const jsonStr = decodeBase64(decodeURIComponent(packRaw));
        const pack = JSON.parse(jsonStr);

        const data = pack.data || {};
        const sign = pack.sign || "";

        // 입력값 + 미리보기 복원
        fields.forEach(id => {
            if (data[id] !== undefined) {
                document.getElementById(id).value = data[id];
                const span = document.getElementById("pv_" + id);
                if (span) span.innerText = data[id];
            }
        });

        // 모바일 서명 이미지 복원
        if (sign) {
            document.getElementById("signPreview").src = sign;
        }
    } catch (e) {
        console.error("pack decode error", e);
    }
})();
</script>

</body>
</html>
