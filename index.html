<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ë†ì‚°ë¬¼ íŒë§¤ í™•ì¸ì„œ</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background:#f5f5f5;
        padding:20px;
    }
    .container {
        max-width:1200px;
        margin:0 auto;
        display:flex;
        gap:20px;
    }
    .box {
        background:white;
        border-radius:10px;
        padding:20px;
        flex:1;
    }
    .input-box input {
        width:100%;
        padding:10px;
        margin-top:5px;
        border:1px solid #ccc;
        border-radius:6px;
        font-size:15px;
    }
    #pcSignCanvas {
        width:100%;
        height:150px;
        border:1px solid #aaa;
        background:white;
        margin-top:5px;
        touch-action:none;
    }
    .title {
        text-align:center;
        font-size:22px;
        font-weight:bold;
        margin-bottom:20px;
    }
    .preview p {
        margin:10px 0;
        font-size:15px;
    }
    #signPreview {
        width:250px;
        height:120px;
        border:1px solid #ccc;
        margin-top:5px;
        background:white;
    }
    #buttons {
        text-align:center;
        margin-top:20px;
    }
    button {
        padding:12px 16px;
        margin:0 6px;
        background:white;
        border:1px solid #ccc;
        border-radius:6px;
        cursor:pointer;
    }
    .blue-btn {
        background:#3b82f6;
        border:none;
        color:white;
    }
    @media (max-width:900px) {
        .container { flex-direction:column; }
    }
    @media print {
        .input-box, #buttons {
            display:none;
        }
        body { background:white; }
        .container { display:block; }
    }
</style>
</head>

<body>

<div class="container">

    <!-- LEFT: ì…ë ¥ -->
    <div class="box input-box">
        <h2>ì…ë ¥ í¼</h2>

        <label>í’ˆëª©</label><input id="item">
        <label>ì›ì‚°ì§€</label><input id="origin">
        <label>ìƒì‚°ë…„ë„</label><input id="year">
        <label>íŒë§¤ëŸ‰</label><input id="qty">
        <label>íŒë§¤ë‹¨ê°€</label><input id="unitPrice">
        <label>ê¸ˆì•¡</label><input id="amount">
        <label>ì…ê¸ˆê³„ì¢Œë²ˆí˜¸</label><input id="bank">
        <label>ì—°ë½ì²˜</label><input id="phone">
        <label>ì„±ëª…</label><input id="name">
        <label>ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</label><input id="rrn">
        <label>ë†ì—…ê²½ì˜ì²´ë“±ë¡ë²ˆí˜¸</label><input id="farmId">
        <label>ë‚ ì§œ</label><input id="date">

        <h3 style="margin-top:30px;">PC ì„œëª…</h3>
        <canvas id="pcSignCanvas"></canvas>
        <button onclick="clearPcSign()" style="margin-top:10px;">ì„œëª… ì§€ìš°ê¸°</button>
    </div>

    <!-- RIGHT: ë¯¸ë¦¬ë³´ê¸° -->
    <div class="box preview" id="printArea">
        <div class="title">ë†ì‚°ë¬¼ íŒë§¤ í™•ì¸ì„œ</div>

        <p>* í’ˆëª© : <span id="pv_item"></span></p>
        <p>* ì›ì‚°ì§€ : <span id="pv_origin"></span></p>
        <p>* ìƒì‚°ë…„ë„ : <span id="pv_year"></span></p>
        <p>* íŒë§¤ëŸ‰ : <span id="pv_qty"></span></p>
        <p>* íŒë§¤ë‹¨ê°€ : <span id="pv_unitPrice"></span></p>
        <p>* ê¸ˆì•¡ : <span id="pv_amount"></span></p>
        <p>* ì…ê¸ˆê³„ì¢Œë²ˆí˜¸ : <span id="pv_bank"></span></p>
        <p>* ì—°ë½ì²˜ : <span id="pv_phone"></span></p>
        <p>* ì„±ëª… : <span id="pv_name"></span></p>
        <p>* ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ : <span id="pv_rrn"></span></p>
        <p>* ë†ì—…ê²½ì˜ì²´ë“±ë¡ë²ˆí˜¸ : <span id="pv_farmId"></span></p>

        <p style="margin:40px 0; text-align:center;">ìœ„ì™€ ê°™ì´ íŒë§¤í•˜ì˜€ìŒì„ í™•ì¸í•©ë‹ˆë‹¤.</p>

        <p><b>ì„œëª…</b></p>
        <img id="signPreview">

        <p style="text-align:center; margin-top:40px; font-weight:bold;">
            ë†ì—…íšŒì‚¬ë²•ì¸(ì£¼)ì›ë‹¹ì—í”„ì•¤ë”” ê·€ì¤‘
        </p>
    </div>

</div>

<div id="buttons">
    <button onclick="saveImage()">ì‚¬ì§„ ì €ì¥</button>
    <button onclick="window.print()">ì¸ì‡„í•˜ê¸°</button>
    <button class="blue-btn" onclick="createSignURL()">ì„œëª… ë°›ê¸° URL ë³µì‚¬</button>
</div>

<script>
/* Base64 Safe */
function encodeBase64(str){ return btoa(unescape(encodeURIComponent(str))); }
function decodeBase64(str){ return decodeURIComponent(escape(atob(str))); }

/* ì…ë ¥ â†’ ë¯¸ë¦¬ë³´ê¸° */
const fields = ["item","origin","year","qty","unitPrice","amount","bank","phone","name","rrn","farmId","date"];
fields.forEach(id=>{
    document.getElementById(id).addEventListener("input",()=>{
        document.getElementById("pv_"+id).innerText = document.getElementById(id).value;
    });
});

/* PC ì„œëª… ìº”ë²„ìŠ¤ */
const canvas = document.getElementById("pcSignCanvas");
const ctx = canvas.getContext("2d");
let drawing = false;

function resizeCanvas(){
    const r = canvas.getBoundingClientRect();
    canvas.width = r.width;
    canvas.height = r.height;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

function pos(e){
    const r = canvas.getBoundingClientRect();
    return { x:e.clientX-r.left, y:e.clientY-r.top };
}

canvas.addEventListener("pointerdown",e=>{
    drawing=true;
    const p=pos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
});
canvas.addEventListener("pointermove",e=>{
    if(!drawing) return;
    const p=pos(e);
    ctx.lineWidth=2;
    ctx.lineCap="round";
    ctx.strokeStyle="black";
    ctx.lineTo(p.x,p.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(p.x,p.y);

    document.getElementById("signPreview").src = canvas.toDataURL();
});
canvas.addEventListener("pointerup",()=>drawing=false);
canvas.addEventListener("pointerleave",()=>drawing=false);

function clearPcSign(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    document.getElementById("signPreview").src = "";
}

/* ì„œëª… URL ìƒì„± */
function createSignURL(){
    const data={};
    fields.forEach(id=>data[id]=document.getElementById(id).value);

    const encoded = encodeBase64(JSON.stringify(data));
    const url = `https://farm-confirmation-qwe.vercel.app/sign.html?data=${encodeURIComponent(encoded)}`;

    navigator.clipboard.writeText(url).then(()=>{
        alert("ì„œëª…ìš© URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
    });
}

/* ì‚¬ì§„ ì €ì¥ */
async function saveImage(){
    const area=document.getElementById("printArea");
    const canvas2=await html2canvas(area,{scale:2});
    const url=canvas2.toDataURL("image/png");
    const link=document.createElement("a");
    link.href=url;
    link.download="í™•ì¸ì„œ.png";
    link.click();
}

/* ğŸ”¥ pack ë³µì› (ëª¨ë°”ì¼ ì„œëª… ì™„ë£Œ í›„ PCì—ì„œ ëŒì•„ì™”ì„ ë•Œ ìˆ˜í–‰) */
(function restoreFromPack(){
    const params = new URLSearchParams(location.search);
    const packRaw = params.get("pack");
    if(!packRaw) return;

    try{
        const packJson = decodeBase64(decodeURIComponent(packRaw));
        const pack = JSON.parse(packJson);

        const data = pack.data;
        const sign = pack.sign;

        fields.forEach(id=>{
            if(data[id]){
                document.getElementById(id).value = data[id];
                document.getElementById("pv_"+id).innerText = data[id];
            }
        });

        if(sign){
            document.getElementById("signPreview").src = sign;
        }
    }catch(e){
        console.error("pack decode error", e);
    }
})();
</script>

</body>
</html>
