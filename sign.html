<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>서명 입력</title>

<style>
    body{font-family:Arial;background:#f5f5f5;margin:0;padding:20px;}
    .box{max-width:600px;margin:0 auto;background:white;padding:20px;border-radius:10px;}
    .title{text-align:center;font-size:22px;font-weight:bold;margin:0 0 20px 0;}
    h3{margin-top:25px;}
    #signCanvas{width:100%;height:220px;border:1px solid #aaa;background:#fff;touch-action:none;}
    button{width:100%;padding:12px;margin-top:12px;border-radius:6px;border:none;font-size:16px;cursor:pointer;}
    .blue-btn{background:#3b82f6;color:white;}
    .gray-btn{background:#e5e7eb;color:#111;}
    .info-line{margin:6px 0;font-size:15px;}
    #msg{margin-top:10px;color:green;font-weight:bold;text-align:center;}
</style>
</head>

<body>

<div class="box">
    <div class="title">농산물 판매 확인서</div>

    <div id="infoArea"></div>

    <h3>서명</h3>
    <canvas id="signCanvas"></canvas>

    <button class="gray-btn" onclick="clearMobileSign()">서명 지우기</button>
    <button class="blue-btn" onclick="submitSign()">서명 완료</button>

    <div id="msg"></div>
</div>

<script>
function decode(str){
    return JSON.parse(decodeURIComponent(escape(atob(str))));
}

/* 데이터 표시 */
let formData = {};
(function loadData(){
    const p = new URLSearchParams(window.location.search);
    const raw = p.get("data");
    if(!raw) return;
    formData = decode(raw);

    const area = document.getElementById("infoArea");
    let html="";
    const labels={
        item:"품목",origin:"원산지",year:"생산년도",qty:"판매량",unitPrice:"판매단가",
        amount:"금액",bank:"입금계좌번호",phone:"연락처",name:"성명",
        rrn:"주민등록번호",farmId:"농업경영체등록번호",date:"날짜"
    };

    for(const k in formData){
        html += `<div class="info-line">* ${labels[k] || k} : ${formData[k]}</div>`;
    }
    area.innerHTML = html;
})();

/* 캔버스 */
const c = document.getElementById("signCanvas");
const ctx = c.getContext("2d");
let drawing=false;

function resize(){
    const r = c.getBoundingClientRect();
    c.width = r.width;
    c.height = r.height;
}
resize();
window.addEventListener("resize",resize);

function pos(e){
    const r = c.getBoundingClientRect();
    return {x: e.clientX - r.left, y:e.clientY - r.top};
}

c.addEventListener("pointerdown", e=>{
    drawing=true;
    const p=pos(e);
    ctx.beginPath();
    ctx.moveTo(p.x,p.y);
});
c.addEventListener("pointermove", e=>{
    if(!drawing) return;
    const p=pos(e);
    ctx.lineWidth=2;
    ctx.lineCap="round";
    ctx.strokeStyle="black";
    ctx.lineTo(p.x,p.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(p.x,p.y);
});
c.addEventListener("pointerup",()=>drawing=false);
c.addEventListener("pointerleave",()=>drawing=false);

function clearMobileSign(){
    ctx.clearRect(0,0,c.width,c.height);
}

/* 서명 완료 */
function submitSign(){
    const sign = c.toDataURL("image/png");

    localStorage.setItem("farm_temp_sign", sign);
    localStorage.setItem("farm_temp_data", JSON.stringify(formData));

    const backURL = window.location.origin + "/index.html?done=1";

    navigator.clipboard.writeText(backURL)
        .then(()=>{
            document.getElementById("msg").innerText =
                "서명 완료! 이제 PC에서 index.html을 여시면 자동으로 복원됩니다.";
        })
        .catch(()=>{
            document.getElementById("msg").innerText =
                "복사 실패. 주소창 URL을 직접 복사해 주세요.";
        });
}
</script>

</body>
</html>
